{% extends "base.html" %}

{% block title %}Database Agent - Technical Skills Registry{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md">
        <div class="p-6">
            <h2 class="text-2xl font-bold mb-4">Database Agent</h2>
            
            <div class="mb-6 text-gray-600">
                <p class="mb-3">Ask questions about users, skills, and their relationships using natural language.</p>
                <p>For example:</p>
                <ul class="list-disc ml-6 space-y-1">
                    <li>"Show me all users who know Python with proficiency level 4 or higher"</li>
                    <li>"What are the most popular skills in the database?"</li>
                    <li>"List all skills in the Frameworks category"</li>
                </ul>
            </div>

            <form id="queryForm" class="mb-6">
                <div class="mb-4">
                    <label for="query" class="block text-sm font-medium text-gray-700 mb-2">Your Question:</label>
                    <textarea
                        id="query"
                        rows="3"
                        required
                        placeholder="Type your question here..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    ></textarea>
                </div>
                <button type="submit" id="submitBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    Ask Question
                </button>
            </form>

            <div id="loadingArea" class="hidden text-center mb-6">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-500 border-t-transparent"></div>
                <p class="mt-2 text-gray-600">Processing your question...</p>
            </div>

            <div id="resultArea" class="hidden">
                <h4 class="text-lg font-semibold mb-3">Results:</h4>
                <div id="queryResult" class="bg-gray-50 p-4 rounded-md">
                    <div id="formattedResponse"></div>
                    <pre id="rawResponse" class="hidden mt-4 bg-gray-100 p-4 rounded-md overflow-x-auto"></pre>
                    <button onclick="toggleRawResponse()" class="mt-3 px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                        Toggle Raw JSON
                    </button>
                </div>
            </div>

            <div id="errorArea" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded" role="alert">
            </div>
        </div>
    </div>
</div>

<script>
    // Handle authentication state
    function updateAuthNav() {
        const token = localStorage.getItem('token');
        const authNav = document.getElementById('authNav');
        
        if (token) {
            authNav.innerHTML = `
                <li class="nav-item">
                    <a class="nav-link" href="/profile">Profile</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" onclick="logout()">Logout</a>
                </li>
            `;
        } else {
            authNav.innerHTML = `
                <li class="nav-item">
                    <a class="nav-link" href="/login">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/register">Register</a>
                </li>
            `;
        }
    }

    // Handle form submission
    document.getElementById('queryForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const query = document.getElementById('query').value;
        const resultArea = document.getElementById('resultArea');
        const queryResult = document.getElementById('queryResult');
        const errorArea = document.getElementById('errorArea');
        const loadingArea = document.getElementById('loadingArea');
        const submitBtn = document.getElementById('submitBtn');
        
        // Hide previous results/errors and show loading
        resultArea.classList.add('hidden');
        errorArea.classList.add('hidden');
        loadingArea.classList.remove('hidden');
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('http://localhost:8000/agent/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to process query');
            }
            
            resultArea.classList.remove('hidden');
            const formattedResponse = document.getElementById('formattedResponse');
            const rawResponse = document.getElementById('rawResponse');
            
            // Format the response based on its content
            if (data.response) {
                try {
                    // Parse the JSON string in data.response
                    const parsedResults = JSON.parse(data.response);
                    
                    if (Array.isArray(parsedResults)) {
                        if (parsedResults.length === 0) {
                            formattedResponse.textContent = 'No results found';
                        } else {
                            // Create a table if the results are objects with properties
                            if (typeof parsedResults[0] === 'object') {
                                const headers = Object.keys(parsedResults[0]);
                                formattedResponse.innerHTML = `
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                ${headers.map(header => `<th>${header}</th>`).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${parsedResults.map(item => `
                                                <tr>
                                                    ${headers.map(header => `<td>${item[header]}</td>`).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                `;
                            } else {
                                // For arrays of primitive values, display as a list
                                formattedResponse.innerHTML = `
                                    <ul class="list-group">
                                        ${parsedResults.map(item => `<li class="list-group-item">${item}</li>`).join('')}
                                    </ul>`;
                            }
                        }
                    } else {
                        // Handle single result
                        formattedResponse.textContent = JSON.stringify(parsedResults, null, 2);
                    }
                } catch (e) {
                    // If parsing fails, display as plain text
                    formattedResponse.textContent = data.response;
                }
            } else {
                formattedResponse.textContent = 'No results found';
            }
            
            // Store raw response
            rawResponse.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
            errorArea.classList.remove('hidden');
            errorArea.textContent = error.message;
        } finally {
            loadingArea.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });

    // Add toggle function for raw response
    function toggleRawResponse() {
        const rawResponse = document.getElementById('rawResponse');
        rawResponse.classList.toggle('hidden');
    }

    // Initialize page
    updateAuthNav();
</script>
{% endblock %}